C51 COMPILER V8.08   18B20                                                                 08/18/2015 10:43:54 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE 18B20
OBJECT MODULE PLACED IN 18b20.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 18b20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************************
   2          * 【编写时间】： 2014年3月5日
   3          * 【作    者】： 清翔电子:03
   4          * 【版    本】： 1.0
   5          * 【网    站】： http://www.qxmcu.com/ 
   6          * 【淘宝店铺】： http://qxmcu.taobao.com/ 
   7          * 【实验平台】： QX-MCS51 单片机开发板
   8          * 【外部晶振】： 11.0592mhz     
   9          * 【主控芯片】： STC89C52
  10          * 【编译环境】： Keil μVisio3  
  11          * 【程序功能】： 实时采集当前环境温度值，并显示于数码管上                                                                                   
  12          * 【使用说明】： 
  13          *  说明：免费开源，不提供源代码分析.
  14          **********************************************************************************/
  15          
  16          #include <reg52.h>
  17          #define uchar unsigned char
  18          #define uint unsigned int
  19          sbit DS=P2^2;           //define interface
  20          uint temp;             // variable of temperature
  21          uchar flag1;            // sign of the result positive or negative
  22          sbit dula=P2^6;
  23          sbit wela=P2^7;
  24          unsigned char code table[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,
  25                                  0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};
  26          unsigned char code table1[]={0xbf,0x86,0xdb,0xcf,0xe6,0xed,0xfd,
  27                                  0x87,0xff,0xef};
  28          
  29          void delay(uint count)      //delay
  30          {
  31   1        uint i;
  32   1        while(count)
  33   1        {
  34   2          i=200;
  35   2          while(i>0)
  36   2          i--;
  37   2          count--;
  38   2        }
  39   1      }
  40          void dsreset(void)       //send reset and initialization command
  41          {
  42   1        uint i;
  43   1        DS=0;
  44   1        i=103;
  45   1        while(i>0)i--;
  46   1        DS=1;
  47   1        i=4;
  48   1        while(i>0)i--;
  49   1      }
  50          
  51          bit tmpreadbit(void)       //read a bit
  52          {
  53   1         uint i;
  54   1         bit dat;
  55   1         DS=0;i++;          //i++ for delay
C51 COMPILER V8.08   18B20                                                                 08/18/2015 10:43:54 PAGE 2   

  56   1         DS=1;i++;i++;
  57   1         dat=DS;
  58   1         i=8;while(i>0)i--;
  59   1         return (dat);
  60   1      }
  61          
  62          uchar tmpread(void)   //read a byte date
  63          {
  64   1        uchar i,j,dat;
  65   1        dat=0;
  66   1        for(i=1;i<=8;i++)
  67   1        {
  68   2          j=tmpreadbit();
  69   2          dat=(j<<7)|(dat>>1);   //读出的数据最低位在最前面，这样刚好一个字节在DAT里
  70   2        }
  71   1        return(dat);
  72   1      }
  73          
  74          void tmpwritebyte(uchar dat)   //write a byte to ds18b20
  75          {
  76   1        uint i;
  77   1        uchar j;
  78   1        bit testb;
  79   1        for(j=1;j<=8;j++)
  80   1        {
  81   2          testb=dat&0x01;
  82   2          dat=dat>>1;
  83   2          if(testb)     //write 1
  84   2          {
  85   3            DS=0;
  86   3            i++;i++;
  87   3            DS=1;
  88   3            i=8;while(i>0)i--;
  89   3          }
  90   2          else
  91   2          {
  92   3            DS=0;       //write 0
  93   3            i=8;while(i>0)i--;
  94   3            DS=1;
  95   3            i++;i++;
  96   3          }
  97   2      
  98   2        }
  99   1      }
 100          
 101          void tmpchange(void)  //DS18B20 begin change
 102          {
 103   1        dsreset();
 104   1        delay(1);
 105   1        tmpwritebyte(0xcc);  // address all drivers on bus
 106   1        tmpwritebyte(0x44);  //  initiates a single temperature conversion
 107   1      }
 108          
 109          uint tmp()               //get the temperature
 110          {
 111   1        float tt;
 112   1        uchar a,b;
 113   1        dsreset();
 114   1        delay(1);
 115   1        tmpwritebyte(0xcc);
 116   1        tmpwritebyte(0xbe);
 117   1        a=tmpread();
C51 COMPILER V8.08   18B20                                                                 08/18/2015 10:43:54 PAGE 3   

 118   1        b=tmpread();
 119   1        temp=b;
 120   1        temp<<=8;             //two byte  compose a int variable
 121   1        temp=temp|a;
 122   1        tt=temp*0.0625;
 123   1        temp=tt*10+0.5;
 124   1        return temp;
 125   1      }
 126          
 127          void display(uint temp)                 //显示程序
 128          {
 129   1         uchar A1,A2,A2t,A3;
 130   1         A1=temp/100;
 131   1         A2t=temp%100;
 132   1         A2=A2t/10;
 133   1         A3=A2t%10;
 134   1         dula=0;
 135   1         P0=table[A1];                //显示百位
 136   1         dula=1;
 137   1         dula=0;
 138   1      
 139   1         wela=0;
 140   1         P0=0xfe;
 141   1         wela=1;
 142   1         wela=0;
 143   1         delay(1);
 144   1      
 145   1         dula=0;
 146   1         P0=table1[A2];               //显示十位
 147   1         dula=1;
 148   1         dula=0;
 149   1      
 150   1         wela=0;
 151   1         P0=0xfd;
 152   1         wela=1;
 153   1         wela=0;
 154   1         delay(1);
 155   1      
 156   1         dula=0;
 157   1         P0=table[A3];                //显示个位
 158   1         dula=1;
 159   1         dula=0;
 160   1      
 161   1         wela=0;
 162   1         P0=0xfb;
 163   1         wela=1;
 164   1         wela=0;
 165   1         delay(1);
 166   1      }
 167          
 168          
 169          void main()
 170          {
 171   1       uchar a;
 172   1        do
 173   1        {
 174   2          tmpchange();
 175   2              for(a=10;a>0;a--)
 176   2              {   
 177   3                      display(tmp());
 178   3              }
 179   2        } while(1);
C51 COMPILER V8.08   18B20                                                                 08/18/2015 10:43:54 PAGE 4   

 180   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    457    ----
   CONSTANT SIZE    =     26    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
