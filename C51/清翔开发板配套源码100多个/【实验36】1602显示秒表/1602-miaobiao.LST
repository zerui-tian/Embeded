C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE 1602_MIAOBIAO
OBJECT MODULE PLACED IN 1602-miaobiao.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 1602-miaobiao.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************************
   2          * 【编写时间】： 2014年3月5日
   3          * 【作    者】： 清翔电子:03
   4          * 【版    本】： 1.0
   5          * 【网    站】： http://www.qxmcu.com/ 
   6          * 【淘宝店铺】： http://qxmcu.taobao.com/ 
   7          * 【实验平台】： QX-MCS51 单片机开发板
   8          * 【外部晶振】： 11.0592mhz     
   9          * 【主控芯片】： STC89C52
  10          * 【编译环境】： Keil μVisio3  
  11          * 【程序功能】：                                                                                    
  12          * 【使用说明】： 液晶1脚接1602黑色排母的1脚  如果是无背光的液晶只有14个脚 排母右边空2个位   
  13                           请把液晶对比度电位器顺时针调制10点钟方向，请勿多调超出极限位置会损坏电位器！
  14          *  说明：免费开源，不提供源代码分析.
  15          **********************************************************************************/
  16          
  17          /*******************************************************************
  18          
  19          
  20          *                                                                       *
  21          * 描述：                                                                *
  22          *                                                                       *
  23          *   上电后液晶屏先显示信息，接着按下S2，定时开始，再次按下              *
  24          *                                                                       *
  25          *   S2暂停，第3次按下显示累积计时，第4次按下暂停计时，任何时候按下S3*
  26          *                                                                       *
  27          *   计数清零。                                                              *
  28          *                                                                                                       *
  29          *                                                                       *
  30          ************************************************************************/
  31          
  32          #include <reg51.h>
  33          #include <intrins.h>
  34          
  35          #define uchar unsigned char
  36          #define uint  unsigned int
  37          
  38          uchar KeyCount=0;
  39          
  40          sbit  S2 = P3^0;
  41          sbit  S3 = P3^1;
  42          
  43          sbit BEEP = P2^3;          //蜂鸣器
  44          
  45          uchar code  cdis1[ ] = {"  STOPWATCH  0  "};
  46          uchar code  cdis2[ ] = {"    QX-MCS51    "};
  47          uchar code  cdis3[ ] = {"TIME            "};
  48          
  49          uchar code  cdis4[ ] = {" BEGIN COUNT  1 "};
  50          uchar code  cdis5[ ] = {" PAUSE COUNT  2 "};
  51          uchar code  cdis6[ ] = {" BEGIN COUNT  3 "};
  52          uchar code  cdis7[ ] = {" PAUSE COUNT  4 "};
  53          uchar code  cdis8[ ] = {"                "};
  54          
  55          sbit LCD_RS = P3^5;             
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 2   

  56          sbit LCD_RW = P3^6;
  57          sbit LCD_EN = P3^4;
  58          sbit dula=P2^6;
  59          sbit wela=P2^7;
  60          
  61          #define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
  62          
  63          uchar display[] =  {0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  64          uchar display2[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  65          
  66          /*********************************************************
  67           延时函数
  68          *********************************************************/
  69          
  70          void Delay(uint num)//延时函数
  71          {
  72   1        while( --num );
  73   1      }
  74          
  75          /*********************************************************
  76           蜂鸣器响一声                                           
  77          **********************************************************/
  78          void beep()
  79          {
  80   1          unsigned char y;
  81   1          for (y=0;y<180;y++)
  82   1          {
  83   2            BEEP=!BEEP;                //BEEP取反
  84   2                Delay(70);
  85   2          } 
  86   1          BEEP=1;                      //关闭蜂鸣器
  87   1      }
  88          
  89          /*********************************************************
  90           延时函数1
  91          *********************************************************/
  92          void delay1(int ms)
  93          {
  94   1         unsigned char n;
  95   1         while(ms--)
  96   1         {
  97   2           for(n = 0; n<250; n++)
  98   2          {
  99   3            _nop_();
 100   3            _nop_();
 101   3            _nop_();
 102   3            _nop_();
 103   3          }
 104   2         }
 105   1      }
 106          
 107          /**********************************************************
 108          *                                                         *
 109          *写指令数据到LCD                                          *
 110          *RS=L，RW=L，E=高脉冲，D0-D7=指令码。                     *
 111          *                                                         *
 112          **********************************************************/
 113          void lcd_wcmd(uchar cmd)
 114          {                          
 115   1      //   while(lcd_busy());
 116   1          LCD_RS = 0;
 117   1      //    LCD_RW = 0;
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 3   

 118   1          LCD_EN = 0;
 119   1          _nop_();
 120   1          _nop_(); 
 121   1          P0 = cmd;
 122   1          delayNOP();
 123   1          LCD_EN = 1;
 124   1          delayNOP();
 125   1          LCD_EN = 0; 
 126   1          Delay(10);
 127   1      }
 128          
 129          /**********************************************************
 130          *                                                         *
 131          *写显示数据到LCD                                          *
 132          *RS=H，RW=L，E=高脉冲，D0-D7=数据。                       *
 133          *                                                         *
 134          **********************************************************/
 135          void lcd_wdat(uchar dat)
 136          {                          
 137   1      //   while(lcd_busy());
 138   1          LCD_RS = 1;
 139   1      //    LCD_RW = 0;
 140   1          LCD_EN = 0;
 141   1          P0 = dat;
 142   1          delayNOP();
 143   1          LCD_EN = 1;
 144   1          delayNOP();
 145   1          LCD_EN = 0; 
 146   1          Delay(10);
 147   1      }
 148          
 149          /**********************************************************
 150          *                                                         *
 151          *  LCD初始化设定                                          *
 152          *                                                         *
 153          **********************************************************/
 154          void lcd_init()
 155          {    
 156   1         
 157   1          LCD_RW = 0;
 158   1              dula=0;
 159   1           wela=0;
 160   1          delay1(15);   
 161   1          lcd_wcmd(0x01);      //清除LCD的显示内容            
 162   1          lcd_wcmd(0x38);      //16*2显示，5*7点阵，8位数据
 163   1          delay1(5);
 164   1          lcd_wcmd(0x38);         
 165   1          delay1(5);
 166   1          lcd_wcmd(0x38);         
 167   1          delay1(5);
 168   1      
 169   1          lcd_wcmd(0x0c);      //开显示，不显示光标  
 170   1          delay1(5);
 171   1      
 172   1          lcd_wcmd(0x01);      //清除LCD的显示内容
 173   1          delay1(5);
 174   1      }
 175          
 176          /**********************************************************
 177          *                                                         *
 178          *  设定显示位置                                           *
 179          *                                                         *
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 4   

 180          **********************************************************/
 181          
 182          void lcd_pos(uchar pos)
 183          {                          
 184   1        lcd_wcmd(pos | 0x80);  //数据指针=80+地址变量
 185   1      }
 186          
 187          /********************************************************
 188           显示函数
 189          *********************************************************/
 190          void play()
 191          {
 192   1         uchar  i;
 193   1         for(i=0;i<6;i++)
 194   1         {
 195   2          display2[i]=display[i]+0x30;  
 196   2         }
 197   1      
 198   1         display2[7]=display[6]/10+0x30;   //时单位数据处理
 199   1         display2[6]=display[6]%10+0x30;
 200   1         
 201   1         lcd_pos(0x45);
 202   1         lcd_wdat(display2[7]);   //显示时
 203   1         lcd_wdat(display2[6]);
 204   1         lcd_wdat(0x3a);          //显示':'
 205   1        
 206   1         lcd_wdat(display2[5]);   //显示分
 207   1         lcd_wdat(display2[4]);
 208   1         lcd_wdat(0x3a);          //显示':'
 209   1      
 210   1         lcd_wdat(display2[3]);   //显示秒
 211   1         lcd_wdat(display2[2]);
 212   1         lcd_wdat(0x3a);          //显示':'
 213   1      
 214   1         lcd_wdat(display2[1]);   //显示毫秒
 215   1         lcd_wdat(display2[0]);  
 216   1      }
 217          
 218          /********************************************************
 219           主函数
 220          *********************************************************/
 221          main()
 222          {
 223   1         uchar m;
 224   1        
 225   1         TMOD=0x01; 
 226   1         TH0=0xdc; TL0=0x00;      //50ms定时   
 227   1         EA=1; ET0=1;
 228   1      
 229   1         lcd_init();
 230   1         
 231   1         lcd_pos(0x00);             //设置显示位置为第一行
 232   1         for(m=0;m<16;m++) 
 233   1         lcd_wdat(cdis1[m]);        //显示字符 
 234   1      
 235   1         lcd_pos(0x40);             //设置显示位置为第二行
 236   1         for(m=0;m<16;m++)
 237   1         {
 238   2          lcd_wdat(cdis2[m]);        //显示字符
 239   2          delay1(60);
 240   2         }
 241   1      
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 5   

 242   1         delay1(100);
 243   1      
 244   1         lcd_pos(0x40);             //设置显示位置为第二行
 245   1         for(m=0;m<16;m++)
 246   1         lcd_wdat(cdis3[m]); 
 247   1      
 248   1         while(1)
 249   1         {   
 250   2           if(S2==0)
 251   2           {
 252   3                 KeyCount++;          //计数
 253   3             beep();
 254   3                 delay1(100);    
 255   3           
 256   3             switch (KeyCount)
 257   3             {
 258   4              case 1: 
 259   4              TR0=1;              //启动中断
 260   4              lcd_pos(0x00);
 261   4                  for(m=0;m<16;m++)
 262   4              lcd_wdat(cdis4[m]);     
 263   4              break;
 264   4        
 265   4              case 2: 
 266   4              TR0=0;              //停止中断
 267   4              lcd_pos(0x00);
 268   4                  for(m=0;m<16;m++)
 269   4              lcd_wdat(cdis5[m]);     
 270   4              break;
 271   4            
 272   4                      case 3: 
 273   4              TR0=1;              //启动中断
 274   4              lcd_pos(0x00);
 275   4                  for(m=0;m<16;m++)
 276   4              lcd_wdat(cdis6[m]);     
 277   4              break;
 278   4      
 279   4              case 4: 
 280   4              TR0=0;              //停止中断
 281   4              lcd_pos(0x00);
 282   4                  for(m=0;m<16;m++)
 283   4              lcd_wdat(cdis7[m]);     
 284   4              break;
 285   4           
 286   4              default:  
 287   4              TR0=0;                   //停止中断 
 288   4              break;
 289   4             }
 290   3           }
 291   2           if(S3==0)
 292   2           {
 293   3                 TR0=0;                     //停止中断
 294   3             KeyCount=0;
 295   3                 for(m=0;m<8;m++)
 296   3             display[m]=0x00;           //计时单元清零
 297   3             lcd_pos(0x00);             //设置显示位置为第一行
 298   3             for(m=0;m<16;m++)
 299   3             lcd_wdat(cdis1[m]); 
 300   3             beep();
 301   3             delay1(100);              
 302   3           } 
 303   2      
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 6   

 304   2           play(); 
 305   2         }
 306   1      }
 307          
 308          /*********************************************************
 309          *                                                        *
 310          * Time0中断函数                                          *
 311          *                                                        *
 312          **********************************************************/
 313          void Time0(void) interrupt 1 using 0
 314          {
 315   1         TH0=0xdc;               //10ms定时
 316   1         TL0=0x00;
 317   1      
 318   1         display[0]++;         //0.01S  
 319   1      
 320   1         if(display[0]==10)
 321   1         {
 322   2          display[0]=0;
 323   2              display[1]++;         //0.1S
 324   2         }
 325   1         if(display[1]==10)
 326   1         {
 327   2          display[1]=0;
 328   2          display[2]++;         //秒个位
 329   2         }
 330   1         if(display[2]==10)
 331   1         {
 332   2          display[2]=0;
 333   2          display[3]++;         //秒十位
 334   2         }
 335   1         if(display[3]==6)
 336   1         {
 337   2          display[3]=0;
 338   2          display[4]++;         //分个位
 339   2         }
 340   1         if(display[4]==10)
 341   1         {
 342   2          display[4]=0;
 343   2          display[5]++;         //分十位
 344   2         }
 345   1         if(display[5]==6)
 346   1         {
 347   2          display[5]=0;
 348   2          display[6]++;        //时
 349   2         }
 350   1         if(display[6]==24)
 351   1         {
 352   2           display[6]=0;
 353   2         } 
 354   1      }
 355          
 356          /*********************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    622    ----
   CONSTANT SIZE    =    136    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V8.08   1602_MIAOBIAO                                                         08/19/2015 12:09:32 PAGE 7   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
