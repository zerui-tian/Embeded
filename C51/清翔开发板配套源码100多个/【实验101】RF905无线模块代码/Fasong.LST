C51 COMPILER V8.08   FASONG                                                                08/19/2015 11:48:44 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE FASONG
OBJECT MODULE PLACED IN Fasong.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Fasong.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //1.      ³ÌÐò·Ö±ðÏÂÔØµ½2¸ö¿ª·¢°å£¬×¢ÒâÁ½¸ö°å¶¼Òª½ÓÉÏUSBµçÔ´¹©µç¡£
   2          //2.    È»ºó°´S2ºó·¢ËÍÐÅÏ¢£¬·¢ËÍÍê±Ïºó·äÃùÆ÷ÏìÒ»ÏÂ£¬¶Ô·½ÊÜµ½ÐÅÏ¢ºóÍ¬Ñù ÏìÒ»ÏÂ¡£
   3          //3.    ¶øÇÒÁ½¸ö¿ª·¢°å¶¼¿ÉÒÔ×öÎª·¢ËÍºÍ½ÓÊÕ£¬Ò»¸ö×öÎª·¢ËÍ£¬¶ÔÓ¦ÁíÒ»¼´Îª½ÓÊÕ,ÊµÏÖ¼°Ê±Ë«ÏòÍ¨ÐÅ¡£
   4          //4.    QX-MCS51¿ª·¢°åÉÏ×îÏÂ½ÇµÚÒ»¸ö°´¼ü
   5          // 
   6          
   7          #include <reg52.h>
   8          #include <ABSACC.h>
   9          #include <intrins.h>
  10          #include <stdio.h>
  11          //--------------------------------------------------------------------------------------------------------
             ---------
  12          #define uint unsigned int
  13          #define uchar unsigned char
  14          //--------------------------------------------------------------------------------------------------------
             ---------
  15          #define BYTE_BIT0       0x01
  16          #define BYTE_BIT7       0x80
  17          //--------------------------------------------------------------------------------------------------------
             ---------
  18          bdata unsigned  char DATA_BUF;
  19          #define DATA7   ((DATA_BUF&BYTE_BIT7) != 0)
  20          #define DATA0   ((DATA_BUF&BYTE_BIT0) != 0)
  21          sbit    flag    =DATA_BUF^7;
  22          sbit    flag1   =DATA_BUF^0;
  23          //---------------------------------------------------·¢ËÍÊý¾Ý»º³åÇø---------------------------------------
             -----------
  24          #define TxRxBuf_Len 4
  25          unsigned char TxRxBuf[TxRxBuf_Len]={0x29,0x30,0x31,0x32,};
  26          code TxAddress[4]={0xcc,0xcc,0xcc,0xcc};
  27          char tf;
  28          //----------------------------------------NRF905¹¤×÷Ä£Ê½¿ØÖÆ¶Ë¿Ú------------------------------------------
             -------------
  29          sbit    TXEN=P1^0;
  30          sbit    TRX_CE=P3^2;
  31          sbit    PWR=P1^1;
  32          //-------------------------------------------------------------------------------------------
  33          sbit    LED=P2^3; //·äÃùÆ÷
  34          //----------------------------------------NRF905 Êý¾Ý½»»»¶Ë¿Ú---------------------------------------------
             -------
  35          sbit    MISO=P1^6;
  36          sbit    MOSI=P1^5;
  37          sbit    SCK=P1^7;
  38          sbit    CSN=P1^3;
  39          //----------------------------------------nrf905×´Ì¬¶Ë¿Ú--------------------------------------------------
             --------
  40          sbit    AM=P1^4;
  41          sbit    DR=P3^3;
  42          sbit    CD=P1^2;
  43          //--------------------------------------------------------------------------------------------------------
             --------
  44          //----------------------------------------°´¼ü¶Ë¿Ú-------------------------------------------------------
  45          sbit    KEY=P3^0;  //QX-MCS51¿ª·¢°åÉÏ×óÏÂ½ÇµÚÒ»¸ö°´¼ü
  46          //----------------------------------------nrf905¿ØÖÆÖ¸Áî-------------------------------------------
  47          #define WC              0x00
C51 COMPILER V8.08   FASONG                                                                08/19/2015 11:48:44 PAGE 2   

  48          #define RC              0x10
  49          #define WTP             0x20
  50          #define RTP             0x21
  51          #define WTA             0x22
  52          #define RTA             0x23
  53          #define RRP             0x24
  54          //------------------------------------------------NRF905¼Ä´æÆ÷ÅäÖÃ----------------------------------------
             ---------
  55          unsigned char idata RFConf[11]=
  56          {
  57            0x00,                             //ÅäÖÃÃüÁî//
  58            0x4c,                             //CH_NO,ÅäÖÃÆµ¶ÎÔÚ430MHZ
  59            0x0c,                             //Êä³ö¹¦ÂÊÎª10db,²»ÖØ·¢£¬½ÚµçÎªÕý³£Ä£Ê½
  60            0x44,                             //µØÖ·¿í¶ÈÉèÖÃ£¬Îª4×Ö½Ú
  61            0x04,0x04,                        //½ÓÊÕ·¢ËÍÓÐÐ§Êý¾Ý³¤¶ÈÎª4×Ö½Ú
  62            0xCC,0xCC,0xCC,0xCC,              //½ÓÊÕµØÖ·
  63            0x58,                              //CRC³äÐí£¬8Î»CRCÐ£Ñé£¬Íâ²¿Ê±ÖÓÐÅºÅ²»Ê¹ÄÜ£¬16M¾§Õñ
  64          };
  65          //================================================ÑÓÊ±====================================================
             -=======
  66          void nrf905_Delay(int n)
  67          {
  68   1              uint i;
  69   1              while(n--)
  70   1              for(i=0;i<80;i++);
  71   1      }
  72          //=================================================SPI¶Áº¯Êý==============================================
             -=========
  73          unsigned char SpiRead(void)
  74          {
  75   1              unsigned char j;
  76   1              for (j=0;j<8;j++)
  77   1              {
  78   2              DATA_BUF=DATA_BUF<<1;
  79   2                      SCK=1;
  80   2                      if (MISO)       //¶ÁÈ¡×î¸ßÎ»£¬±£´æÖÁ×îÄ©Î²£¬Í¨¹ý×óÒÆÎ»Íê³ÉÕû¸ö×Ö½Ú
  81   2                      {
  82   3                              DATA_BUF|=BYTE_BIT0;
  83   3                      }
  84   2                      else
  85   2                      {
  86   3                              DATA_BUF&=~BYTE_BIT0;
  87   3                      }
  88   2                      SCK=0;
  89   2               }
  90   1               return DATA_BUF;
  91   1      }
  92          //===========================================SPIÐ´º¯Êý====================================================
             -===========
  93          void SpiWrite(unsigned char send)
  94          {
  95   1              unsigned char i;
  96   1              DATA_BUF=send;
  97   1              for (i=0;i<8;i++)
  98   1              {
  99   2                      if (DATA7)      //×ÜÊÇ·¢ËÍ×î¸ßÎ»
 100   2                      {
 101   3                              MOSI=1;
 102   3                      }
 103   2                      else
 104   2                      {
 105   3                              MOSI=0;
C51 COMPILER V8.08   FASONG                                                                08/19/2015 11:48:44 PAGE 3   

 106   3                      }
 107   2                      SCK=1;
 108   2                      DATA_BUF=DATA_BUF<<1;
 109   2                      SCK=0;
 110   2              }
 111   1      }
 112          //------------------------------------------------------³õÊ¼»¯nRF905--------------------------------------
             --------
 113          void nRF905Init(void)
 114          {
 115   1          CSN=1;                                              // Spi  disable
 116   1              SCK=0;                                          // Spi clock line init low
 117   1              DR=1;                                           // Init DR for input
 118   1              AM=1;                                           // Init AM for input
 119   1              CD=1;                                           // Init CD for input
 120   1              PWR=1;                                  // nRF905 power on
 121   1              TRX_CE=0;                                       // Set nRF905 in standby mode
 122   1              TXEN=0;                                 // set radio in Rx mode
 123   1      }
 124          //-----------------------------------------------------³õÊ¼»¯¼Ä´æÆ÷---------------------------------------
             ---------
 125          void Config905(void)
 126          {
 127   1              uchar i;
 128   1              CSN=0;                                          // Spi enable for write a spi command
 129   1              //SpiWrite(WC);                         // Write config commandÐ´·ÅÅäÖÃÃüÁî
 130   1              for (i=0;i<11;i++)      // Write configration words  Ð´·ÅÅäÖÃ×Ö
 131   1              {
 132   2                 SpiWrite(RFConf[i]);
 133   2              }
 134   1              CSN=1;                                  // Disable Spi
 135   1      }
 136          //-----------------------------------------------------·¢ËÍÊý¾Ý´ò°ü---------------------------------------
             -------------
 137          void TxPacket(uchar *TxRxBuf)
 138          {
 139   1              uchar i;
 140   1              //Config905();
 141   1              CSN=0;
 142   1              SpiWrite(WTP);                          // Write payload command
 143   1              for (i=0;i<4;i++)
 144   1              {
 145   2                      SpiWrite(TxRxBuf[i]);           // Write 32 bytes Tx data
 146   2              }
 147   1              CSN=1;
 148   1              nrf905_Delay(1);                                                // Spi disable
 149   1              CSN=0;                                          // Spi enable for write a spi command
 150   1              SpiWrite(WTA);                          // Write address command
 151   1              for (i=0;i<4;i++)                       // Ð´ÈëÓë¶Ô·½µØÖ·Ò»ÑùµÄµØÖ·
 152   1              {
 153   2                      SpiWrite(TxAddress[i]);
 154   2              }
 155   1              CSN=1;                                          // Spi disable
 156   1              TRX_CE=1;                                       // Set TRX_CE high,start Tx data transmission
 157   1              nrf905_Delay(1);                                        // while (DR!=1);
 158   1              TRX_CE=0;                                       // Set TRX_CE low
 159   1      }
 160          //----------------------------------------------ÉèÖÃ·¢ËÍ³õÊ¼×´Ì¬------------------------------------------
             ----
 161          void SetTxMode(void)
 162          {
 163   1              TRX_CE=0;
C51 COMPILER V8.08   FASONG                                                                08/19/2015 11:48:44 PAGE 4   

 164   1              TXEN=1;
 165   1              nrf905_Delay(1);                                        // nrf905_Delay for mode change(>=650us)
 166   1      }
 167          //-----------------------------------------------ÉèÖÃ½ÓÊÕ³õÊ¼»¯-------------------------------------------
             ---------
 168          void SetRxMode(void)
 169          {
 170   1              TXEN=0;
 171   1              TRX_CE=1;
 172   1              nrf905_Delay(1);                                        // nrf905_Delay for mode change(>=650us)
 173   1      }
 174          //-------------------------------------------------ÅÐ¶ÏÊý¾Ý½ÓÊÕ×´Ì¬---------------------------------------
             ---------------
 175          unsigned char CheckDR(void)             //¼ì²éÊÇ·ñÓÐÐÂÊý¾Ý´«Èë Data Ready
 176          {
 177   1              DR=1;      
 178   1      //Í¨¹ý¶Ô¶Ë¿ÚÐ´1£¬¿ÉÒÔÊ¹¶Ë¿ÚÎªÊäÈë×´Ì¬£¬Õâ51µÄ ÌØÐÔ¡£²»ÊìÏ¤Õß¿ÉÒÔ²ÎÔÄ51Ïà¹ØÊé¼®×÷Ö¤(½«DR¶Ë¿ÚÉèÖÃÎªÊäÈë×´Ì¬¡
             -£)
 179   1              if (DR==1)
 180   1              {
 181   2                      DR=0;
 182   2                      return 1;
 183   2              }
 184   1              else
 185   1              {
 186   2                      return 0;
 187   2              }
 188   1      
 189   1      }
 190          //----------------------------------------------------¶ÁNRF905½ÓÊÕÊý¾Ý------------------------------------
             -------------------------
 191          void RxPacket(void)                                             
 192          {
 193   1              uchar i;
 194   1          nrf905_Delay(1);
 195   1      //      TRX_CE=0;                                       // Set nRF905 in standby mode
 196   1          nrf905_Delay(100);
 197   1          TRX_CE=0;
 198   1              CSN=0;                                          // Spi enable for write a spi command
 199   1          nrf905_Delay(1);
 200   1              SpiWrite(RRP);
 201   1              for (i = 0 ;i < 4 ;i++)
 202   1              { 
 203   2                      TxRxBuf[i]=SpiRead();           // Read data and save to buffer       
 204   2              }
 205   1              CSN=1;
 206   1          nrf905_Delay(10);
 207   1              TRX_CE=1;                                                       
 208   1      }
 209          //--------------------------------------------------------Êý¾Ý½ÓÊÕ----------------------------------------
             ---------
 210          void  RX(void)
 211          {
 212   1                SetRxMode();  
 213   1              //  while (CheckDR()==0);  ÎªÁËÊµÏÖË«ÏòÍ¨ÐÅ£¬¾Í²»ÄÜÒ»Ö±´¦ÓÚ½ÓÊÕµÈ´ý×´Ì¬£¬ËùÒÔ×¢ÊÍµô
 214   1                        nrf905_Delay(10);
 215   1                        RxPacket();
 216   1                        if(TxRxBuf[0]==0x29)
 217   1                        {
 218   2                                      LED=0;
 219   2                                  nrf905_Delay(300);
 220   2                                      LED=1;
C51 COMPILER V8.08   FASONG                                                                08/19/2015 11:48:44 PAGE 5   

 221   2                                  nrf905_Delay(300);//½ÓÊÕµ½Êý¾Ý ºóÉÁË¸
 222   2                        }
 223   1      
 224   1      }
 225          //--------------------------------------------------------------------------------------------------------
             ----------
 226          void main(void)
 227          {
 228   1              nRF905Init();
 229   1              Config905();
 230   1                      LED=1;
 231   1              while(1)
 232   1                      {
 233   2                              RX();
 234   2                         if(KEY ==0 )
 235   2                               {      
 236   3                                      while(KEY==0);
 237   3                                      tf = 1 ;
 238   3                                      TxRxBuf[0]=0x29;
 239   3                                       }
 240   2                        
 241   2                     if (tf==1)
 242   2                              {
 243   3                      SetTxMode();
 244   3                                  TxPacket(TxRxBuf);  // ·¢ËÍÃüÁîÊý¾Ý
 245   3                                      LED=0;
 246   3                                  nrf905_Delay(300);
 247   3                                      LED=1;
 248   3                                  nrf905_Delay(300);                  //·¢ËÍºó·äÃùÆ÷ÏìÒ»ÏÂ
 249   3                                      tf = 0; 
 250   3                              }       
 251   2      }
 252   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    396    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       3
   IDATA SIZE       =     11    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
